"use strict";(self.webpackChunkwebsite_next=self.webpackChunkwebsite_next||[]).push([[6095],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=d(n),m=i,k=u["".concat(s,".").concat(m)]||u[m]||c[m]||r;return n?a.createElement(k,o(o({ref:t},p),{},{components:n})):a.createElement(k,o({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var d=2;d<r;d++)o[d]=n[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},36130:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>c,frontMatter:()=>r,metadata:()=>l,toc:()=>d});var a=n(87462),i=(n(67294),n(3905));const r={id:"cookbooks-deduplication",title:"Message deduplication",sidebar_label:"Message deduplication",original_id:"cookbooks-deduplication"},o=void 0,l={unversionedId:"cookbooks-deduplication",id:"version-2.1.0-incubating/cookbooks-deduplication",title:"Message deduplication",description:"Message deduplication is a feature of Pulsar that, when enabled, ensures that each message produced on Pulsar topics is persisted to disk only once, even if the message is produced more than once. Message deduplication essentially unburdens Pulsar applications of the responsibility of ensuring deduplication and instead handles it automatically on the server side.",source:"@site/versioned_docs/version-2.1.0-incubating/cookbooks-deduplication.md",sourceDirName:".",slug:"/cookbooks-deduplication",permalink:"/docs/2.1.0-incubating/cookbooks-deduplication",draft:!1,editUrl:"https://github.com/apache/pulsar/edit/master/site2/docs/cookbooks-deduplication.md",tags:[],version:"2.1.0-incubating",frontMatter:{id:"cookbooks-deduplication",title:"Message deduplication",sidebar_label:"Message deduplication",original_id:"cookbooks-deduplication"},sidebar:"version-2.1.0-incubating/docsSidebar",previous:{title:"Topic compaction",permalink:"/docs/2.1.0-incubating/cookbooks-compaction"},next:{title:"Non-persistent messaging",permalink:"/docs/2.1.0-incubating/cookbooks-non-persistent"}},s={},d=[{value:"How it works",id:"how-it-works",level:2},{value:"Configuration for message deduplication",id:"configuration-for-message-deduplication",level:2},{value:"Setting the broker-level default",id:"default",level:3},{value:"Enabling message deduplication",id:"enabling",level:3},{value:"Disabling message deduplication",id:"disabling",level:3},{value:"Message deduplication and Pulsar clients",id:"clients",level:2},{value:"Java clients",id:"java",level:3},{value:"Python clients",id:"python",level:3},{value:"C++ clients",id:"cpp",level:3}],p={toc:d};function c(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Message deduplication")," is a feature of Pulsar that, when enabled, ensures that each message produced on Pulsar topics is persisted to disk ",(0,i.kt)("em",{parentName:"p"},"only once"),", even if the message is produced more than once. Message deduplication essentially unburdens Pulsar applications of the responsibility of ensuring deduplication and instead handles it automatically on the server side."),(0,i.kt)("p",null,"Using message deduplication in Pulsar involves making some ",(0,i.kt)("a",{parentName:"p",href:"#configuration"},"configuration changes")," to your Pulsar brokers as well as some minor changes to the behavior of Pulsar ",(0,i.kt)("a",{parentName:"p",href:"#clients"},"clients"),"."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"For a more thorough theoretical explanation of message deduplication, see the ",(0,i.kt)("a",{parentName:"p",href:"/docs/2.1.0-incubating/concepts-messaging#message-deduplication"},"Concepts and Architecture")," document.")),(0,i.kt)("h2",{id:"how-it-works"},"How it works"),(0,i.kt)("p",null,"Message deduplication can be enabled and disabled on a per-namespace basis. By default, it is ",(0,i.kt)("em",{parentName:"p"},"disabled")," on all namespaces and can enabled in the following ways:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Using the ",(0,i.kt)("a",{parentName:"li",href:"#enabling"},(0,i.kt)("inlineCode",{parentName:"a"},"pulsar-admin namespaces"))," interface"),(0,i.kt)("li",{parentName:"ul"},"As a broker-level ",(0,i.kt)("a",{parentName:"li",href:"#default"},"default")," for all namespaces")),(0,i.kt)("h2",{id:"configuration-for-message-deduplication"},"Configuration for message deduplication"),(0,i.kt)("p",null,"You can configure message deduplication in Pulsar using the ",(0,i.kt)("a",{parentName:"p",href:"/docs/2.1.0-incubating/reference-configuration#broker"},(0,i.kt)("inlineCode",{parentName:"a"},"broker.conf"))," configuration file. The following deduplication-related parameters are available:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:"left"},"Parameter"),(0,i.kt)("th",{parentName:"tr",align:"left"},"Description"),(0,i.kt)("th",{parentName:"tr",align:"left"},"Default"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"brokerDeduplicationEnabled")),(0,i.kt)("td",{parentName:"tr",align:"left"},"Sets the default behavior for message deduplication in the Pulsar ",(0,i.kt)("a",{parentName:"td",href:"/docs/2.1.0-incubating/reference-terminology#broker"},"broker"),". If set to ",(0,i.kt)("inlineCode",{parentName:"td"},"true"),", message deduplication will be enabled by default on all namespaces; if set to ",(0,i.kt)("inlineCode",{parentName:"td"},"false")," (the default), deduplication will have to be ",(0,i.kt)("a",{parentName:"td",href:"#enabling"},"enabled")," and ",(0,i.kt)("a",{parentName:"td",href:"#disabling"},"disabled")," on a per-namespace basis."),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"false"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"brokerDeduplicationMaxNumberOfProducers")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The maximum number of producers for which information will be stored for deduplication purposes."),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"10000"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"brokerDeduplicationEntriesInterval")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The number of entries after which a deduplication informational snapshot is taken. A larger interval will lead to fewer snapshots being taken, though this would also lengthen the topic recovery time (the time required for entries published after the snapshot to be replayed)."),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"1000"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"brokerDeduplicationProducerInactivityTimeoutMinutes")),(0,i.kt)("td",{parentName:"tr",align:"left"},"The time of inactivity (in minutes) after which the broker will discard deduplication information related to a disconnected producer."),(0,i.kt)("td",{parentName:"tr",align:"left"},(0,i.kt)("inlineCode",{parentName:"td"},"360")," (6 hours)")))),(0,i.kt)("h3",{id:"default"},"Setting the broker-level default"),(0,i.kt)("p",null,"By default, message deduplication is ",(0,i.kt)("em",{parentName:"p"},"disabled")," on all Pulsar namespaces. To enable it by default on all namespaces, set the ",(0,i.kt)("inlineCode",{parentName:"p"},"brokerDeduplicationEnabled")," parameter to ",(0,i.kt)("inlineCode",{parentName:"p"},"true")," and re-start the broker."),(0,i.kt)("p",null,"Regardless of the value of ",(0,i.kt)("inlineCode",{parentName:"p"},"brokerDeduplicationEnabled"),", ",(0,i.kt)("a",{parentName:"p",href:"#enabling"},"enabling")," and ",(0,i.kt)("a",{parentName:"p",href:"#disabling"},"disabling")," via the CLI will override the broker-level default."),(0,i.kt)("h3",{id:"enabling"},"Enabling message deduplication"),(0,i.kt)("p",null,"You can enable message deduplication on specific namespaces, regardless of the the ",(0,i.kt)("a",{parentName:"p",href:"#default"},"default")," for the broker, using the ",(0,i.kt)("a",{parentName:"p",href:"/docs/2.1.0-incubating/reference-pulsar-admin#namespace-set-deduplication"},(0,i.kt)("inlineCode",{parentName:"a"},"pulsar-admin namespace set-deduplication"))," command. You can use the ",(0,i.kt)("inlineCode",{parentName:"p"},"--enable"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"-e")," flag and specify the namespace. Here's an example with ",(0,i.kt)("inlineCode",{parentName:"p"},"<tenant>/<namespace>"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"\n$ bin/pulsar-admin namespaces set-deduplication \\\n  public/default \\\n  --enable # or just -e\n\n")),(0,i.kt)("h3",{id:"disabling"},"Disabling message deduplication"),(0,i.kt)("p",null,"You can disable message deduplication on a specific namespace using the same method shown ",(0,i.kt)("a",{parentName:"p",href:"#enabling"},"above"),", except using the ",(0,i.kt)("inlineCode",{parentName:"p"},"--disable"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"-d")," flag instead. Here's an example with ",(0,i.kt)("inlineCode",{parentName:"p"},"<tenant>/<namespace>"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"\n$ bin/pulsar-admin namespaces set-deduplication \\\n  public/default \\\n  --disable # or just -d\n\n")),(0,i.kt)("h2",{id:"clients"},"Message deduplication and Pulsar clients"),(0,i.kt)("p",null,"If you enable message deduplication in your Pulsar brokers, you won't need to make any major changes to your Pulsar clients. There are, however, two settings that you need to provide for your client producers:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"The producer must be given a name"),(0,i.kt)("li",{parentName:"ol"},"The message send timeout needs to be set to infinity (i.e. no timeout)")),(0,i.kt)("p",null,"Instructions for ",(0,i.kt)("a",{parentName:"p",href:"#java"},"Java"),", ",(0,i.kt)("a",{parentName:"p",href:"#python"},"Python"),", and ",(0,i.kt)("a",{parentName:"p",href:"#cpp"},"C++")," clients can be found below."),(0,i.kt)("h3",{id:"java"},"Java clients"),(0,i.kt)("p",null,"To enable message deduplication on a ",(0,i.kt)("a",{parentName:"p",href:"/docs/2.1.0-incubating/client-libraries-java#producers"},"Java producer"),", set the producer name using the ",(0,i.kt)("inlineCode",{parentName:"p"},"producerName")," setter and set the timeout to 0 using the ",(0,i.kt)("inlineCode",{parentName:"p"},"sendTimeout")," setter. Here's an example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.pulsar.client.api.Producer;\nimport org.apache.pulsar.client.api.PulsarClient;\nimport java.util.concurrent.TimeUnit;\n\nPulsarClient pulsarClient = PulsarClient.builder()\n        .serviceUrl("pulsar://localhost:6650")\n        .build();\nProducer producer = pulsarClient.newProducer()\n        .producerName("producer-1")\n        .topic("persistent://public/default/topic-1")\n        .sendTimeout(0, TimeUnit.SECONDS)\n        .create();\n\n')),(0,i.kt)("h3",{id:"python"},"Python clients"),(0,i.kt)("p",null,"To enable message deduplication on a ",(0,i.kt)("a",{parentName:"p",href:"/docs/2.1.0-incubating/client-libraries-python#producers"},"Python producer"),", set the producer name using ",(0,i.kt)("inlineCode",{parentName:"p"},"producer_name")," and the timeout to 0 using ",(0,i.kt)("inlineCode",{parentName:"p"},"send_timeout_millis"),". Here's an example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'\nimport pulsar\n\nclient = pulsar.Client("pulsar://localhost:6650")\nproducer = client.create_producer(\n    "persistent://public/default/topic-1",\n    producer_name="producer-1",\n    send_timeout_millis=0)\n\n')),(0,i.kt)("h3",{id:"cpp"},"C++ clients"),(0,i.kt)("p",null,"To enable message deduplication on a ",(0,i.kt)("a",{parentName:"p",href:"/docs/2.1.0-incubating/client-libraries-cpp#producer"},"C++ producer"),", set the producer name using ",(0,i.kt)("inlineCode",{parentName:"p"},"producer_name")," and the timeout to 0 using ",(0,i.kt)("inlineCode",{parentName:"p"},"send_timeout_millis"),". Here's an example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-cpp"},'\n#include <pulsar/Client.h>\n\nstd::string serviceUrl = "pulsar://localhost:6650";\nstd::string topic = "persistent://some-tenant/ns1/topic-1";\nstd::string producerName = "producer-1";\n\nClient client(serviceUrl);\n\nProducerConfiguration producerConfig;\nproducerConfig.setSendTimeout(0);\nproducerConfig.setProducerName(producerName);\n\nProducer producer;\n\nResult result = client.createProducer(topic, producerConfig, producer);\n\n')))}c.isMDXComponent=!0}}]);