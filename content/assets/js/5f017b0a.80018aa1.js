"use strict";(self.webpackChunkwebsite_next=self.webpackChunkwebsite_next||[]).push([[9562],{3905:(e,t,r)=>{r.d(t,{Zo:()=>p,kt:()=>d});var n=r(67294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=n.createContext({}),c=function(e){var t=n.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},p=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),h=c(r),d=a,m=h["".concat(l,".").concat(d)]||h[d]||u[d]||i;return r?n.createElement(m,o(o({ref:t},p),{},{components:r})):n.createElement(m,o({ref:t},p))}));function d(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=r.length,o=new Array(i);o[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var c=2;c<i;c++)o[c]=r[c];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}h.displayName="MDXCreateElement"},94230:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var n=r(87462),a=(r(67294),r(3905));const i={id:"security-tls-transport",title:"Transport Encryption using TLS",sidebar_label:"Transport Encryption using TLS",original_id:"security-tls-transport"},o=void 0,s={unversionedId:"security-tls-transport",id:"version-2.1.0-incubating/security-tls-transport",title:"Transport Encryption using TLS",description:"TLS Overview",source:"@site/versioned_docs/version-2.1.0-incubating/security-tls-transport.md",sourceDirName:".",slug:"/security-tls-transport",permalink:"/docs/2.1.0-incubating/security-tls-transport",draft:!1,editUrl:"https://github.com/apache/pulsar/edit/master/site2/docs/security-tls-transport.md",tags:[],version:"2.1.0-incubating",frontMatter:{id:"security-tls-transport",title:"Transport Encryption using TLS",sidebar_label:"Transport Encryption using TLS",original_id:"security-tls-transport"},sidebar:"version-2.1.0-incubating/docsSidebar",previous:{title:"Overview",permalink:"/docs/2.1.0-incubating/security-overview"},next:{title:"Authentication using TLS",permalink:"/docs/2.1.0-incubating/security-tls-authentication"}},l={},c=[{value:"TLS Overview",id:"tls-overview",level:2},{value:"TLS concepts",id:"tls-concepts",level:2},{value:"Creating TLS Certificates",id:"creating-tls-certificates",level:2},{value:"Certificate authority",id:"certificate-authority",level:3},{value:"Server certificate",id:"server-certificate",level:3},{value:"Broker Configuration",id:"broker-configuration",level:2},{value:"Proxy Configuration",id:"proxy-configuration",level:2},{value:"Client configuration",id:"client-configuration",level:2},{value:"CLI tools",id:"cli-tools",level:3},{value:"Java client",id:"java-client",level:3},{value:"Python client",id:"python-client",level:3},{value:"C++ client",id:"c-client",level:3}],p={toc:c};function u(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"tls-overview"},"TLS Overview"),(0,a.kt)("p",null,"By default, Apache Pulsar clients communicate with the Apache Pulsar service in plain text, which means that all data is sent in the clear. TLS can be used to encrypt this traffic so that it cannot be snooped by a man-in-the-middle attacker."),(0,a.kt)("p",null,"TLS can be configured for both encryption and authentication. You may configure just TLS transport encryption, which is covered in this guide. TLS authentication is covered ",(0,a.kt)("a",{parentName:"p",href:"/docs/2.1.0-incubating/security-tls-authentication"},"elsewhere"),". Alternatively, you can use ",(0,a.kt)("a",{parentName:"p",href:"security-athenz"},"another authentication mechanism")," on top of TLS transport encryption."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Note that enabling TLS may have a performance impact due to encryption overhead.")),(0,a.kt)("h2",{id:"tls-concepts"},"TLS concepts"),(0,a.kt)("p",null,"TLS is a form of ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Public-key_cryptography"},"public key cryptography"),". Encryption is performed using key pairs consisting of a public key and a private key. Messages are encrypted with the public key and can be decrypted with the private key."),(0,a.kt)("p",null,"To use TLS transport encryption, you need two kinds of key pairs, ",(0,a.kt)("strong",{parentName:"p"},"server key pairs")," and a ",(0,a.kt)("strong",{parentName:"p"},"certificate authority"),"."),(0,a.kt)("p",null,"A third kind of key pair, ",(0,a.kt)("strong",{parentName:"p"},"client key pairs"),", are used for ",(0,a.kt)("a",{parentName:"p",href:"security-tls-authentication"},"client authentication"),"."),(0,a.kt)("p",null,"The ",(0,a.kt)("strong",{parentName:"p"},"certificate authority")," private key should be stored in a very secure location (a fully encrypted, disconnected, air gapped computer). The certificate authority public key, the ",(0,a.kt)("strong",{parentName:"p"},"trust cert"),", can be freely shared."),(0,a.kt)("p",null,"For both client and server key pairs, the administrator first generates a private key and a certificate request. Then the certificate authority private key is used to sign the certificate request, generating a certificate. This certificate is the public key for the server/client key pair."),(0,a.kt)("p",null,"For TLS transport encryption, the clients can use the ",(0,a.kt)("strong",{parentName:"p"},"trust cert")," to verify that the server they are talking to has a key pair that was signed by the certificate authority. A man-in-the-middle attacker would not have access to the certificate authority, so they couldn't create a server with such a key pair."),(0,a.kt)("p",null,"For TLS authentication, the server uses the ",(0,a.kt)("strong",{parentName:"p"},"trust cert")," to verify that the client has a key pair that was signed by the certificate authority. The Common Name of the ",(0,a.kt)("strong",{parentName:"p"},"client cert")," is then used as the client's role token (see ",(0,a.kt)("a",{parentName:"p",href:"security-overview"},"Overview"),")."),(0,a.kt)("h2",{id:"creating-tls-certificates"},"Creating TLS Certificates"),(0,a.kt)("p",null,"Creating TLS certificates for Pulsar involves creating a ",(0,a.kt)("a",{parentName:"p",href:"#certificate-authority"},"certificate authority")," (CA), ",(0,a.kt)("a",{parentName:"p",href:"#server-certificate"},"server certificate"),", and ",(0,a.kt)("a",{parentName:"p",href:"#client-certificate"},"client certificate"),"."),(0,a.kt)("p",null,"The following guide is an abridged guide to setting up a certificate authority. For a more detailed guide, there are plenty of resource on the internet. We recommend the ",(0,a.kt)("a",{parentName:"p",href:"https://jamielinux.com/docs/openssl-certificate-authority/index.html"},"this guide"),"."),(0,a.kt)("h3",{id:"certificate-authority"},"Certificate authority"),(0,a.kt)("p",null,"The first step is to create the certificate for the CA. The CA will be used to sign both the broker and client certificates, in order to ensure that each party will trust the others. The CA should be stored in a very secure location (ideally completely disconnected from networks, air gapped, and fully encrypted)."),(0,a.kt)("p",null,"Create a directory for your CA, and place ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/apache/incubator-pulsar/tree/master/site2/website/static/examples/openssl.cnf"},"this openssl configuration file")," in the directory. You may want to modify the default answers for company name and department in the configuration file. Export the location of the CA directory to the environment variable, CA_HOME. The configuration file uses this environment variable to find the rest of the files and directories needed for the CA."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"\nmkdir my-ca\ncd my-ca\nwget https://raw.githubusercontent.com/apache/pulsar-site/main/site2/website/static/examples/openssl.cnf\nexport CA_HOME=$(pwd)\n\n")),(0,a.kt)("p",null,"Create the necessary directories, keys and certs."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"\nmkdir certs crl newcerts private\nchmod 700 private/\ntouch index.txt\necho 1000 > serial\nopenssl genrsa -aes256 -out private/ca.key.pem 4096\nchmod 400 private/ca.key.pem\nopenssl req -config openssl.cnf -key private/ca.key.pem \\\n    -new -x509 -days 7300 -sha256 -extensions v3_ca \\\n    -out certs/ca.cert.pem\nchmod 444 certs/ca.cert.pem\n\n")),(0,a.kt)("p",null,"After answering the question prompts, this will store CA-related files in the ",(0,a.kt)("inlineCode",{parentName:"p"},"./my-ca")," directory. Within that directory:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"certs/ca.cert.pem")," is the public certificate. It is meant to be distributed to all parties involved."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"private/ca.key.pem")," is the private key. This is only needed when signing a new certificate for either broker or clients and it must be safely guarded.")),(0,a.kt)("h3",{id:"server-certificate"},"Server certificate"),(0,a.kt)("p",null,"Once a CA certificate has been created, you can create certificate requests and sign them with the CA."),(0,a.kt)("p",null,"The following commands will ask you a few questions and then create the certificates. When asked for the common name, you should match the hostname of the broker. You could also use a wildcard to match a group of broker hostnames, for example ",(0,a.kt)("inlineCode",{parentName:"p"},"*.broker.usw.example.com"),". This ensures that the same certificate can be reused on multiple machines."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Sometimes it is not possible or makes no sense to match the hostname,\nsuch as when the brokers are created with random hostnames, or you\nplan to connect to the hosts via their IP. In this case, the client\nshould be configured to disable TLS hostname verification.")),(0,a.kt)("p",null,"First generate the key."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"\nopenssl genrsa -out broker.key.pem 2048\n\n")),(0,a.kt)("p",null,"The broker expects the key to be in ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/PKCS_8"},"PKCS 8")," format, so convert it."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"\nopenssl pkcs8 -topk8 -inform PEM -outform PEM \\\n    -in broker.key.pem -out broker.key-pk8.pem -nocrypt\n\n")),(0,a.kt)("p",null,"Generate the certificate request..."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"\nopenssl req -config openssl.cnf \\\n    -key broker.key.pem -new -sha256 -out broker.csr.pem\n\n")),(0,a.kt)("p",null,"... and sign it with the certificate authority."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"\nopenssl ca -config openssl.cnf -extensions server_cert \\\n    -days 1000 -notext -md sha256 \\\n    -in broker.csr.pem -out broker.cert.pem\n\n")),(0,a.kt)("p",null,"At this point, you have a cert, ",(0,a.kt)("inlineCode",{parentName:"p"},"broker.cert.pem"),", and a key, ",(0,a.kt)("inlineCode",{parentName:"p"},"broker.key-pk8.pem"),", which can be used along with ",(0,a.kt)("inlineCode",{parentName:"p"},"ca.cert.pem")," to configure TLS transport encryption for your broker and proxy nodes."),(0,a.kt)("h2",{id:"broker-configuration"},"Broker Configuration"),(0,a.kt)("p",null,"To configure a Pulsar ",(0,a.kt)("a",{parentName:"p",href:"/docs/2.1.0-incubating/reference-terminology#broker"},"broker")," to use TLS transport encryption, you'll need to make some changes to ",(0,a.kt)("inlineCode",{parentName:"p"},"broker.conf"),", which is located in the ",(0,a.kt)("inlineCode",{parentName:"p"},"conf")," directory of your ",(0,a.kt)("a",{parentName:"p",href:"getting-started-standalone"},"Pulsar installation"),"."),(0,a.kt)("p",null,"Add these values to the configuration file (substituting the appropriate certificate paths where necessary):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-properties"},"\ntlsEnabled=true\ntlsCertificateFilePath=/path/to/broker.cert.pem\ntlsKeyFilePath=/path/to/broker.key-pk8.pem\ntlsTrustCertsFilePath=/path/to/ca.cert.pem\n\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"A full list of parameters available in the ",(0,a.kt)("inlineCode",{parentName:"p"},"conf/broker.conf")," file,\nas well as the default values for those parameters, can be found in ",(0,a.kt)("a",{parentName:"p",href:"/docs/2.1.0-incubating/reference-configuration#broker"},"Broker Configuration")," ")),(0,a.kt)("h2",{id:"proxy-configuration"},"Proxy Configuration"),(0,a.kt)("p",null,"Proxies need to configure TLS in two directions, for clients connecting to the proxy, and for the proxy to be able to connect to brokers."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-properties"},"\n# For clients connecting to the proxy\ntlsEnabledInProxy=true\ntlsCertificateFilePath=/path/to/broker.cert.pem\ntlsKeyFilePath=/path/to/broker.key-pk8.pem\ntlsTrustCertsFilePath=/path/to/ca.cert.pem\n\n# For the proxy to connect to brokers\ntlsEnabledWithBroker=true\nbrokerClientTrustCertsFilePath=/path/to/ca.cert.pem\n\n")),(0,a.kt)("h2",{id:"client-configuration"},"Client configuration"),(0,a.kt)("p",null,"When TLS transport encryption is enabled, you need to configure the client to use ",(0,a.kt)("inlineCode",{parentName:"p"},"https://")," and port 8443 for the web service URL, and ",(0,a.kt)("inlineCode",{parentName:"p"},"pulsar+ssl://")," and port 6651 for the broker service URL."),(0,a.kt)("p",null,"As the server certificate you generated above doesn't belong to any of the default trust chains, you also need to either specify the path the ",(0,a.kt)("strong",{parentName:"p"},"trust cert")," (recommended), or tell the client to allow untrusted server certs."),(0,a.kt)("h3",{id:"cli-tools"},"CLI tools"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"reference-cli-tools"},"Command-line tools")," like ",(0,a.kt)("a",{parentName:"p",href:"reference-cli-tools#pulsar-admin"},(0,a.kt)("inlineCode",{parentName:"a"},"pulsar-admin")),", ",(0,a.kt)("a",{parentName:"p",href:"reference-cli-tools#pulsar-perf"},(0,a.kt)("inlineCode",{parentName:"a"},"pulsar-perf")),", and ",(0,a.kt)("a",{parentName:"p",href:"reference-cli-tools#pulsar-client"},(0,a.kt)("inlineCode",{parentName:"a"},"pulsar-client"))," use the ",(0,a.kt)("inlineCode",{parentName:"p"},"conf/client.conf")," config file in a Pulsar installation."),(0,a.kt)("p",null,"You'll need to add the following parameters to that file to use TLS transport with Pulsar's CLI tools:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-properties"},"\nwebServiceUrl=https://broker.example.com:8443/\nbrokerServiceUrl=pulsar+ssl://broker.example.com:6651/\nuseTls=true\ntlsAllowInsecureConnection=false\ntlsTrustCertsFilePath=/path/to/ca.cert.pem\n\n")),(0,a.kt)("h3",{id:"java-client"},"Java client"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.pulsar.client.api.PulsarClient;\n\nPulsarClient client = PulsarClient.builder()\n    .serviceUrl("pulsar+ssl://broker.example.com:6651/")\n    .enableTls(true)\n    .tlsTrustCertsFilePath("/path/to/ca.cert.pem")\n    .build();\n\n')),(0,a.kt)("h3",{id:"python-client"},"Python client"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},'\nfrom pulsar import Client\n\nclient = Client("pulsar+ssl://broker.example.com:6651/",\n                tls_trust_certs_file_path="/path/to/ca.cert.pem",\n                tls_allow_insecure_connection=False)\n\n')),(0,a.kt)("h3",{id:"c-client"},"C++ client"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-c++"},'\n#include <pulsar/Client.h>\n\npulsar::ClientConfiguration config;\nconfig.setUseTls(true);\nconfig.setTlsTrustCertsFilePath("/path/to/ca.cert.pem");\nconfig.setTlsAllowInsecureConnection(false);\n\npulsar::Client client("pulsar+ssl://broker.example.com:6651/", config);\n\n')))}u.isMDXComponent=!0}}]);